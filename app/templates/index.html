<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êé®ËçêÊôØÁÇπ</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        
        .white-container {
            position: absolute;
            top: 185px;
            left: 0;
            width: 100%;
            height: 100px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        .blue-container {
            position: absolute;
            top: 125px;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #0052d9;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
        }
        
        .nav-item {
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-item:hover {
            background-color: #003bb3;
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
            position: relative;
            top: 20px;
        }
        .image-container {
            position: absolute;
            left: 330px;
            top: 29px;
            transform: translateY(-50%);
            width: 280px;
            height: 80px;
            background: url('../static/dogo.png') center center/contain no-repeat;
            z-index: 999;
        }
        .header span {
            font-weight: bold;
            position: absolute;
            right: 32%;
            display: flex;
            align-items: center;
            height: 100%;
            top: 22px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .header .search-bar {
            display: flex;
            max-width: 400px;
            height: 48px;
            gap: 0px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 5px;
        }
        .header .search-bar select {
            padding: 12px 16px;
            border: 1px solid #CCCCCC;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            min-width: 100px;
        }
        .header .search-input {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            height: 46px;
            top: 1px;
        }
        .header .search-input svg {
            position: absolute;
            left: 16px;
            pointer-events: none;
        }
        .header .search-input input {
            width: 100%;
            height: 46px;
            padding: 0 16px 0 48px;
            border: 1px solid #CCCCCC;
            border-left: none;
            border-right: none;
            font-size: 14px;
        }
        .header .search-input input::placeholder {
            color: #999999;
        }
        .header .search-button {
            padding: 12px 16px;
            background-color: #FF6600;
            color: #FFFFFF;
            border: none;
            border-radius: 0 4px 4px 0;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header .search-button:hover {
            background-color: #E55C00;
        }
        .header .search-button:active {
            transform: translateY(1px);
        }
        .header .actions {
            display: flex;
            gap: 10px;
            position: absolute;
            right: 29%;
            top: 17px;
        }
        .header button, .header a.button {
            padding: 0;
            cursor: pointer;
            text-decoration: none;
            background-color: transparent;
            border: none;
            color: #333;
        }
        .header a.button:hover {
            color: #0066cc;
        }
        #logout-button {
            font-size: 16px;
            margin-left: 10px;
        }
        #logout-button:hover {
            color: #0066cc;
        }
        
        @media (max-width: 768px) {
            .header .search-bar { height: 40px; }
            .header .search-button span { display: none; }
            .header .search-button::after { content: "üîç"; }
        }
        
        /* Ê†áÈ¢òÊ†∑Âºè‰ºòÂåñ */
        h2 { 
            text-align: center; 
            font-size: 2.5rem; 
            text-shadow: 2px 2px 4px #f0f0f0;
            margin-bottom: 40px;
            margin-top: 400px;
        }
        
        /* ÊôØÁÇπÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .spots-list { 
            list-style: none; 
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            max-width: 660px;
            margin: 0 auto;
            margin-top: 200px;
        }
        
        @media (max-width: 768px) {
            .spots-list {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* ÊôØÁÇπÂç°ÁâáÊ†∑Âºè */
        .spots-list li { 
            border: 1px solid #eee; 
            padding: 0;
            margin-bottom: 0;
            border-radius: 12px;
            overflow: hidden;
            height: 300px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(50px);
            animation: fadeInUp 800ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            transition: transform 300ms ease, box-shadow 300ms ease;
        }
        
        .spots-list li:nth-child(odd) {
            animation-delay: 100ms;
        }
        
        .spots-list li:nth-child(even) {
            animation-delay: 300ms;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spots-list li:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* ÂõæÁâáÂå∫Âüü */
        .spots-list li img {
            width: 100%;
            height: 50%;
            object-fit: cover;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
            display: block;
            transition: transform 0.3s;
        }

        .spot-info {
            padding: 0.8rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-bottom: 1px solid #dfe6e9;
        }
        
        .spot-info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.05);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .spots-list li:hover .spot-info::after {
            opacity: 1;
        }
        
        .spots-list h3 { 
            margin: 0 auto 15px auto; 
            font-size: 1.4rem;
            font-family: 'Noto Sans SC', sans-serif;
            color: #2d3436;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        
        .spots-list p { 
            margin: 5px 0; 
            font-size: 0.9em; 
            color: #555;
        }
    </style>
</head>
<body>

    <div class="white-container"></div>

    <div class="blue-container">
    <div class="nav-item" onclick="window.location.href='/spots/spot_info/145'">
        Êé®ËçêÊôØÂå∫
    </div>
    <div class="nav-item" onclick="window.location.href='/spots/spot_info/143'">
        Âè£Á¢ëÊó•ËÆ∞
    </div>
</div>

    <div class="header">
        <div class="image-container"></div>
        <span id="username">ËÆøÂÆ¢</span>
        <div class="search-bar">
            <select aria-label="ÊêúÁ¥¢Á±ªÂûã">
                <option value="spot">ÊôØÂå∫</option>
                <option value="diary">Êó•ËÆ∞</option>
            </select>
            <div class="search-input">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="#666666">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" placeholder="ËØ∑ËæìÂÖ•ÂÖ≥ÈîÆËØç" aria-label="ÊêúÁ¥¢ÂÖ≥ÈîÆËØç">
            </div>
            <button class="search-button">ÊêúÁ¥¢</button>
        </div>
        <div class="actions">
            <button id="logout-button">ÁôªÂá∫</button>
        </div>
    </div>

<h2>‰∏∫ÊÇ®Êé®ËçêÁöÑÊôØÁÇπ</h2>
<ul id="spots-list" class="spots-list">
    <!-- Êé®ËçêÊôØÁÇπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
    <li>Âä†ËΩΩ‰∏≠...</li>
</ul>

<script>
    // ‰øÆÊîπfetchRecommendedSpotsÂáΩÊï∞‰∏≠ÁöÑHTMLÁîüÊàêÈÉ®ÂàÜ
    function fetchRecommendedSpots() {
        fetch('/api/recommended-spots')
            .then(response => response.json())
            .then(data => {
                spotsList.innerHTML = '';
                if (data.success && data.spots && data.spots.length > 0) {
                    data.spots.forEach(spot => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${spot.img ? `<img src="${spot.img}" alt="${spot.name || 'Êú™Áü•ÊôØÁÇπ'}">` : ''}
                            <div class="spot-info">
                                <h3><a href="/spots/spot_info/${spot.id || 'Êú™Áü•ID'}">${spot.name || 'Êú™Áü•ÊôØÁÇπ'}</a></h3>
                                <p>ËØÑÂàÜ: ${spot.score !== undefined ? spot.score : 'N/A'}</p>
                                <p title="${spot.type || 'Êú™Áü•Á±ªÂûã'}">Á±ªÂûã: ${spot.type || 'Êú™Áü•Á±ªÂûã'}</p>
                            </div>
                        `;
                        spotsList.appendChild(li);
                    });
                } else {
                    spotsList.innerHTML = '<li>ÊöÇÊó†Êé®ËçêÊôØÁÇπ„ÄÇ</li>';
                }
            })
            .catch(error => {
                console.error('Ëé∑ÂèñÊé®ËçêÊôØÁÇπÊó∂Âá∫Èîô:', error);
                spotsList.innerHTML = '<li>Âä†ËΩΩÊé®ËçêÊôØÁÇπÊó∂Âá∫ÈîôÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ</li>';
            });
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const usernameSpan = document.getElementById('username');
        const spotsList = document.getElementById('spots-list');
        const logoutButton = document.getElementById('logout-button');
        const searchBar = document.querySelector('.search-bar');
        const searchSelect = searchBar.querySelector('select');
        const searchInput = searchBar.querySelector('input');
        const searchButton = searchBar.querySelector('.search-button');

        // 1. Ê£ÄÊü•‰ºöËØùÂπ∂Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
        fetch('/api/check-session')
            .then(response => {
                if (!response.ok) {
                    // Â¶ÇÊûúÊú™ÊéàÊùÉ (401) ÊàñÂÖ∂‰ªñÈîôËØØÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ
                    if (response.status === 401) {
                        window.location.href = '/login'; // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢ÁöÑË∑ØÁî±
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return null; // Èò≤Ê≠¢Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    usernameSpan.textContent = data.user.username || 'Áî®Êà∑';
                    // Áî®Êà∑‰ø°ÊÅØËé∑ÂèñÊàêÂäüÂêéÔºåËé∑ÂèñÊé®ËçêÊôØÁÇπ
                    fetchRecommendedSpots();
                } else if (data) {
                     // Âç≥‰ΩøÊàêÂäüÂìçÂ∫îÔºå‰πüÂèØËÉΩ‰∏öÂä°ÈÄªËæëÂ§±Ë¥•
                     console.error('‰ºöËØùÊ£ÄÊü•Â§±Ë¥•:', data.message);
                     window.location.href = '/login';
                }
                // Â¶ÇÊûú response.ok ‰∏∫ false ‰∏îÈùû 401ÔºåÂàô‰∏ç‰ºöÊâßË°åÂà∞ËøôÈáå
            })
            .catch(error => {
                console.error('Ê£ÄÊü•‰ºöËØùÊó∂Âá∫Èîô:', error);
                usernameSpan.textContent = 'ÈîôËØØ';
                spotsList.innerHTML = '<li>Êó†Ê≥ïÂä†ËΩΩÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Â∞ùËØïÈáçÊñ∞ÁôªÂΩï„ÄÇ</li>';
                // ÂèØÈÄâÔºö‰πüÂú®Ê≠§Â§ÑÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ
                // window.location.href = '/login';
            });

        // 2. Ëé∑ÂèñÊé®ËçêÊôØÁÇπÂáΩÊï∞
        function fetchRecommendedSpots() {
            fetch('/api/recommended-spots') // ËØ∑Ê±ÇÊñ∞ÁöÑÊé®Ëçê API
                .then(response => {
                    if (!response.ok) {
                         // Â¶ÇÊûúÊú™ÊéàÊùÉÔºå‰πüÈáçÂÆöÂêë
                        if (response.status === 401) {
                            window.location.href = '/login';
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    spotsList.innerHTML = ''; // Ê∏ÖÁ©∫Âä†ËΩΩÊèêÁ§∫
                    if (data.success && data.spots && data.spots.length > 0) {
                        data.spots.forEach(spot => {
                            const li = document.createElement('li');
                            // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÊØè‰∏™Â≠óÊÆµÔºåÊèê‰æõÈªòËÆ§ÂÄº
                            const id = spot.id || 'Êú™Áü•ID';
                            const name = spot.name || 'Êú™Áü•ÊôØÁÇπ';
                            const score = spot.score !== undefined ? spot.score : 'N/A'; // ËØÑÂàÜÂèØËÉΩÊòØ 0
                            const type = spot.type || 'Êú™Áü•Á±ªÂûã';
                            const visitedTime = spot.visited_time || 'Êú™Áü•'; // ÂÅáËÆæ visited_time ÊòØ‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÊèèËø∞ÔºåÂ¶Ç "Á∫¶2Â∞èÊó∂"
                            const imgUrl = spot.img || ''; // ÂõæÁâá URLÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰∏∫Á©∫

                            // ÊûÑÂª∫ÂàóË°®È°πÁöÑ HTML ÂÜÖÂÆπ
                            li.innerHTML = `
                                ${imgUrl ? `<img src="${imgUrl}" alt="${name}" style="max-width: 100px; max-height: 80px; float: left; margin-right: 10px;">` : ''}
                                <h3><a href="/spots/spot_info/${id}">${name}</a></h3> <!-- ‰øÆÊîπËøôÈáåÔºåÂ∞ÜÂêçÂ≠óÂèò‰∏∫ÈìæÊé• -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; font-family: serif; font-size: 0.9rem; line-height: 1.6; color: #636e72;">
                                    <div>ID: ${id}</div>
                                    <div>Ê†áÁ≠æ: ${type}</div>
                                    <div>ËØÑÂàÜ: ${score}</div>
                                    <div>ÊµèËßà: ${visitedTime}</div>
                                </div>
                                <div style="clear: both;"></div> <!-- Ê∏ÖÈô§ÊµÆÂä® -->
                            `;
                            spotsList.appendChild(li);
                        });
                    } else if (data.success) {
                        spotsList.innerHTML = '<li>ÊöÇÊó†Êé®ËçêÊôØÁÇπ„ÄÇ</li>';
                    } else {
                        spotsList.innerHTML = `<li>Âä†ËΩΩÊé®ËçêÊôØÁÇπÂ§±Ë¥•: ${data.message || 'Êú™Áü•ÈîôËØØ'}</li>`;
                    }
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÊé®ËçêÊôØÁÇπÊó∂Âá∫Èîô:', error);
                    spotsList.innerHTML = '<li>Âä†ËΩΩÊé®ËçêÊôØÁÇπÊó∂Âá∫ÈîôÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ</li>';
                });
        }

        // 3. Â§ÑÁêÜÊêúÁ¥¢
        function handleSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                // Á©∫ÂÖ≥ÈîÆËØçÊèêÁ§∫
                searchInput.style.borderColor = 'red';
                searchInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    searchInput.style.borderColor = '#CCCCCC';
                    searchInput.style.animation = '';
                }, 500);
                return;
            }
            
            const searchType = searchSelect.value;
            const apiUrl = new URL('/api/search-spots', window.location.origin);
            apiUrl.searchParams.append('keyword', keyword);
            if (searchType === 'diary') {
                apiUrl.searchParams.append('type', 'diary');
            }
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/login';
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && Array.isArray(data.spots)) {
                        window.location.href = `/spots/search?keyword=${encodeURIComponent(keyword)}`;
                    } else {
                        showToast('ÊêúÁ¥¢ÊúçÂä°ÊöÇ‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï');
                    }
                })
                .catch(error => {
                    console.error('ÊêúÁ¥¢Êó∂Âá∫Èîô:', error);
                    showToast('ÊêúÁ¥¢ÊúçÂä°ÊöÇ‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï');
                });
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = 'rgba(0,0,0,0.7)';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '4px';
            toast.style.zIndex = '1000';
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        
        // 4. Â§ÑÁêÜÁôªÂá∫
        logoutButton.addEventListener('click', () => {
            fetch('/api/logout', { method: 'POST' }) // ÊúÄÂ•Ω‰ΩøÁî® POST ËØ∑Ê±ÇÁôªÂá∫
                .then(response => {
                    // ‰∏çËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÂ∞ùËØïÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ
                    window.location.href = '/login'; // ÂÅáËÆæÁôªÂá∫ API ‰ºöÂ§ÑÁêÜÈáçÂÆöÂêëÔºåÊàñËÄÖÂâçÁ´ØÂº∫Âà∂Ë∑≥ËΩ¨
                })
                .catch(error => {
                    console.error('ÁôªÂá∫Êó∂Âá∫Èîô:', error);
                    // Âç≥‰ΩøÂá∫ÈîôÔºå‰πüÂ∞ùËØïË∑≥ËΩ¨
                    window.location.href = '/login';
                });
        });
    });
</script>

</body>
</html>
