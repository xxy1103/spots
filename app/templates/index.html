<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨èæ™¯ç‚¹</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        
        .white-container {
            position: absolute;
            top: 185px;
            left: 0;
            width: 100%;
            height: 100px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        .blue-container {
            position: absolute;
            top: 125px;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #0052d9;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
        }
        
        .nav-item {
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-item:hover {
            background-color: #003bb3;
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
            position: relative;
            top: 20px;
        }
        .image-container {
            position: absolute;
            left: 330px;
            top: 29px;
            transform: translateY(-50%);
            width: 280px;
            height: 80px;
            background: url('../static/dogo.png') center center/contain no-repeat;
            z-index: 999;
        }
        .header span {
            font-weight: bold;
            position: absolute;
            right: 32%;
            display: flex;
            align-items: center;
            height: 100%;
            top: 22px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .header .search-bar {
            display: flex;
            max-width: 400px;
            height: 48px;
            gap: 0px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 5px;
        }
        .header .search-bar select {
            padding: 12px 16px;
            border: 1px solid #CCCCCC;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            min-width: 100px;
        }
        .header .search-input {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            height: 46px;
            top: 1px;
        }
        .header .search-input svg {
            position: absolute;
            left: 16px;
            pointer-events: none;
        }
        .header .search-input input {
            width: 100%;
            height: 46px;
            padding: 0 16px 0 48px;
            border: 1px solid #CCCCCC;
            border-left: none;
            border-right: none;
            font-size: 14px;
        }
        .header .search-input input::placeholder {
            color: #999999;
        }
        .header .search-button {
            padding: 12px 16px;
            background-color: #FF6600;
            color: #FFFFFF;
            border: none;
            border-radius: 0 4px 4px 0;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header .search-button:hover {
            background-color: #E55C00;
        }
        .header .search-button:active {
            transform: translateY(1px);
        }
        .header .actions {
            display: flex;
            gap: 10px;
            position: absolute;
            right: 29%;
            top: 17px;
        }
        .header button, .header a.button {
            padding: 0;
            cursor: pointer;
            text-decoration: none;
            background-color: transparent;
            border: none;
            color: #333;
        }
        .header a.button:hover {
            color: #0066cc;
        }
        #logout-button {
            font-size: 16px;
            margin-left: 10px;
        }
        #logout-button:hover {
            color: #0066cc;
        }
        
        @media (max-width: 768px) {
            .header .search-bar { height: 40px; }
            .header .search-button span { display: none; }
            .header .search-button::after { content: "ğŸ”"; }
        }
        
        /* æ ‡é¢˜æ ·å¼ä¼˜åŒ– */
        h2 { 
            text-align: center; 
            font-size: 2.5rem; 
            text-shadow: 2px 2px 4px #f0f0f0;
            margin-bottom: 40px;
            margin-top: 400px;
        }
        
        /* æ™¯ç‚¹ç½‘æ ¼å¸ƒå±€ */
        .spots-list { 
            list-style: none; 
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            max-width: 660px;
            margin: 0 auto;
            margin-top: 200px;
        }
        
        @media (max-width: 768px) {
            .spots-list {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* æ™¯ç‚¹å¡ç‰‡æ ·å¼ */
        .spots-list li { 
            border: 1px solid #eee; 
            padding: 0;
            margin-bottom: 0;
            border-radius: 12px;
            overflow: hidden;
            height: 300px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(50px);
            animation: fadeInUp 800ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            transition: transform 300ms ease, box-shadow 300ms ease;
        }
        
        .spots-list li:nth-child(odd) {
            animation-delay: 100ms;
        }
        
        .spots-list li:nth-child(even) {
            animation-delay: 300ms;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spots-list li:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* å›¾ç‰‡åŒºåŸŸ */
        .spots-list li img {
            width: 100%;
            height: 50%;
            object-fit: cover;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
            display: block;
            transition: transform 0.3s;
        }

        .spot-info {
            padding: 0.8rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-bottom: 1px solid #dfe6e9;
        }
        
        .spot-info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.05);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .spots-list li:hover .spot-info::after {
            opacity: 1;
        }
        
        .spots-list h3 { 
            margin: 0 auto 15px auto; 
            font-size: 1.4rem;
            font-family: 'Noto Sans SC', sans-serif;
            color: #2d3436;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        
        .spots-list p { 
            margin: 5px 0; 
            font-size: 0.9em; 
            color: #555;
        }
    </style>
</head>
<body>

    <div class="white-container"></div>

    <div class="blue-container">
    <div class="nav-item" onclick="window.location.href='/spots/spot_info/145'">
        æ¨èæ™¯åŒº
    </div>
    <div class="nav-item" onclick="window.location.href='/spots/spot_info/143'">
        å£ç¢‘æ—¥è®°
    </div>
</div>

    <div class="header">
        <div class="image-container"></div>
        <span id="username">è®¿å®¢</span>
        <div class="search-bar">
            <select aria-label="æœç´¢ç±»å‹">
                <option value="spot">æ™¯åŒº</option>
                <option value="diary">æ—¥è®°</option>
            </select>
            <div class="search-input">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="#666666">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input type="text" placeholder="è¯·è¾“å…¥å…³é”®è¯" aria-label="æœç´¢å…³é”®è¯">
            </div>
            <button class="search-button">æœç´¢</button>
        </div>
        <div class="actions">
            <button id="logout-button">ç™»å‡º</button>
        </div>
    </div>

<h2>ä¸ºæ‚¨æ¨èçš„æ™¯ç‚¹</h2>
<ul id="spots-list" class="spots-list">
    <!-- æ¨èæ™¯ç‚¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    <li>åŠ è½½ä¸­...</li>
</ul>

<script>
    // ä¿®æ”¹fetchRecommendedSpotså‡½æ•°ä¸­çš„HTMLç”Ÿæˆéƒ¨åˆ†
    function fetchRecommendedSpots() {
        fetch('/api/recommended-spots')
            .then(response => response.json())
            .then(data => {
                spotsList.innerHTML = '';
                if (data.success && data.spots && data.spots.length > 0) {
                    data.spots.forEach(spot => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${spot.img ? `<img src="${spot.img}" alt="${spot.name || 'æœªçŸ¥æ™¯ç‚¹'}">` : ''}
                            <div class="spot-info">
                                <h3><a href="/spots/spot_info/${spot.id || 'æœªçŸ¥ID'}">${spot.name || 'æœªçŸ¥æ™¯ç‚¹'}</a></h3>
                                <p>è¯„åˆ†: ${spot.score !== undefined ? spot.score : 'N/A'}</p>
                                <p title="${spot.type || 'æœªçŸ¥ç±»å‹'}">ç±»å‹: ${spot.type || 'æœªçŸ¥ç±»å‹'}</p>
                            </div>
                        `;
                        spotsList.appendChild(li);
                    });
                } else {
                    spotsList.innerHTML = '<li>æš‚æ— æ¨èæ™¯ç‚¹ã€‚</li>';
                }
            })
            .catch(error => {
                console.error('è·å–æ¨èæ™¯ç‚¹æ—¶å‡ºé”™:', error);
                spotsList.innerHTML = '<li>åŠ è½½æ¨èæ™¯ç‚¹æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚</li>';
            });
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const usernameSpan = document.getElementById('username');
        const spotsList = document.getElementById('spots-list');
        const logoutButton = document.getElementById('logout-button');
        const searchBar = document.querySelector('.search-bar');
        const searchSelect = searchBar.querySelector('select');
        const searchInput = searchBar.querySelector('input');
        const searchButton = searchBar.querySelector('.search-button');

        // 1. æ£€æŸ¥ä¼šè¯å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
        fetch('/api/check-session')
            .then(response => {
                if (!response.ok) {
                    // å¦‚æœæœªæˆæƒ (401) æˆ–å…¶ä»–é”™è¯¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    if (response.status === 401) {
                        window.location.href = '/login'; // è·³è½¬åˆ°ç™»å½•é¡µé¢çš„è·¯ç”±
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return null; // é˜²æ­¢è¿›ä¸€æ­¥å¤„ç†
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    usernameSpan.textContent = data.user.username || 'ç”¨æˆ·';
                    // ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸåï¼Œè·å–æ¨èæ™¯ç‚¹
                    fetchRecommendedSpots();
                } else if (data) {
                     // å³ä½¿æˆåŠŸå“åº”ï¼Œä¹Ÿå¯èƒ½ä¸šåŠ¡é€»è¾‘å¤±è´¥
                     console.error('ä¼šè¯æ£€æŸ¥å¤±è´¥:', data.message);
                     window.location.href = '/login';
                }
                // å¦‚æœ response.ok ä¸º false ä¸”é 401ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
            })
            .catch(error => {
                console.error('æ£€æŸ¥ä¼šè¯æ—¶å‡ºé”™:', error);
                usernameSpan.textContent = 'é”™è¯¯';
                spotsList.innerHTML = '<li>æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å°è¯•é‡æ–°ç™»å½•ã€‚</li>';
                // å¯é€‰ï¼šä¹Ÿåœ¨æ­¤å¤„é‡å®šå‘åˆ°ç™»å½•é¡µ
                // window.location.href = '/login';
            });

        // 2. è·å–æ¨èæ™¯ç‚¹å‡½æ•°
        function fetchRecommendedSpots() {
            fetch('/api/recommended-spots') // è¯·æ±‚æ–°çš„æ¨è API
                .then(response => {
                    if (!response.ok) {
                         // å¦‚æœæœªæˆæƒï¼Œä¹Ÿé‡å®šå‘
                        if (response.status === 401) {
                            window.location.href = '/login';
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    spotsList.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º
                    if (data.success && data.spots && data.spots.length > 0) {
                        data.spots.forEach(spot => {
                            const li = document.createElement('li');
                            // å®‰å…¨åœ°è·å–æ¯ä¸ªå­—æ®µï¼Œæä¾›é»˜è®¤å€¼
                            const id = spot.id || 'æœªçŸ¥ID';
                            const name = spot.name || 'æœªçŸ¥æ™¯ç‚¹';
                            const score = spot.score !== undefined ? spot.score : 'N/A'; // è¯„åˆ†å¯èƒ½æ˜¯ 0
                            const type = spot.type || 'æœªçŸ¥ç±»å‹';
                            const visitedTime = spot.visited_time || 'æœªçŸ¥'; // å‡è®¾ visited_time æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æè¿°ï¼Œå¦‚ "çº¦2å°æ—¶"
                            const imgUrl = spot.img || ''; // å›¾ç‰‡ URLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©º

                            // æ„å»ºåˆ—è¡¨é¡¹çš„ HTML å†…å®¹
                            li.innerHTML = `
                                ${imgUrl ? `<img src="${imgUrl}" alt="${name}" style="max-width: 100px; max-height: 80px; float: left; margin-right: 10px;">` : ''}
                                <h3><a href="/spots/spot_info/${id}">${name}</a></h3> <!-- ä¿®æ”¹è¿™é‡Œï¼Œå°†åå­—å˜ä¸ºé“¾æ¥ -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; font-family: serif; font-size: 0.9rem; line-height: 1.6; color: #636e72;">
                                    <div>ID: ${id}</div>
                                    <div>æ ‡ç­¾: ${type}</div>
                                    <div>è¯„åˆ†: ${score}</div>
                                    <div>æµè§ˆ: ${visitedTime}</div>
                                </div>
                                <div style="clear: both;"></div> <!-- æ¸…é™¤æµ®åŠ¨ -->
                            `;
                            spotsList.appendChild(li);
                        });
                    } else if (data.success) {
                        spotsList.innerHTML = '<li>æš‚æ— æ¨èæ™¯ç‚¹ã€‚</li>';
                    } else {
                        spotsList.innerHTML = `<li>åŠ è½½æ¨èæ™¯ç‚¹å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</li>`;
                    }
                })
                .catch(error => {
                    console.error('è·å–æ¨èæ™¯ç‚¹æ—¶å‡ºé”™:', error);
                    spotsList.innerHTML = '<li>åŠ è½½æ¨èæ™¯ç‚¹æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚</li>';
                });
        }

        // 3. å¤„ç†æœç´¢
        function handleSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                // ç©ºå…³é”®è¯æç¤º
                searchInput.style.borderColor = 'red';
                searchInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    searchInput.style.borderColor = '#CCCCCC';
                    searchInput.style.animation = '';
                }, 500);
                return;
            }
            
            const searchType = searchSelect.value;
            const apiUrl = new URL('/api/search-spots', window.location.origin);
            apiUrl.searchParams.append('keyword', keyword);
            if (searchType === 'diary') {
                apiUrl.searchParams.append('type', 'diary');
            }
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/login';
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && Array.isArray(data.spots)) {
                        window.location.href = `/spots/search?keyword=${encodeURIComponent(keyword)}`;
                    } else {
                        showToast('æœç´¢æœåŠ¡æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                    }
                })
                .catch(error => {
                    console.error('æœç´¢æ—¶å‡ºé”™:', error);
                    showToast('æœç´¢æœåŠ¡æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                });
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = 'rgba(0,0,0,0.7)';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '4px';
            toast.style.zIndex = '1000';
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        
        // 4. å¤„ç†ç™»å‡º
        logoutButton.addEventListener('click', () => {
            fetch('/api/logout', { method: 'POST' }) // æœ€å¥½ä½¿ç”¨ POST è¯·æ±‚ç™»å‡º
                .then(response => {
                    // ä¸è®ºæˆåŠŸä¸å¦ï¼Œéƒ½å°è¯•é‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = '/login'; // å‡è®¾ç™»å‡º API ä¼šå¤„ç†é‡å®šå‘ï¼Œæˆ–è€…å‰ç«¯å¼ºåˆ¶è·³è½¬
                })
                .catch(error => {
                    console.error('ç™»å‡ºæ—¶å‡ºé”™:', error);
                    // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•è·³è½¬
                    window.location.href = '/login';
                });
        });
    });
</script>

</body>
</html>
