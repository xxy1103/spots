<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图显示</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 80vh;
        }
        .map-container {
            flex: 3;
            height: 80vh; /* 留出底部空间 */
        }
        .right-sidebar {
            flex: 1;
            background-color: #f5f5f5;
            padding: 10px;
            height: 80vh; /* 留出底部空间 */
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            display: flex; /* 使用 Flexbox 布局 */
            flex-direction: column; /* 垂直排列 */
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .bottom-area {
            height: 20vh;
            background-color: #f5f5f5;
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            overflow-y: auto; /* 如果内容过多则滚动 */
        }

        /* 标签切换样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
            flex-shrink: 0; /* 防止标签区域被压缩 */
        }
        .tab-button {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 2px;
        }
        .tab-button.active {
            background: #fff;
            border: 1px solid #ccc;
            border-bottom: none;
        }
        .tab-content {
            display: none;
            flex-grow: 1; /* 占据剩余空间 */
            overflow-y: auto; /* 内容过多时滚动 */
            padding: 10px;
        }
        .tab-content.active {
            display: block;
        }
        /* POI 列表样式 */
        #poi-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #poi-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        #poi-list li:hover {
            background-color: #f0f0f0;
        }
        #poi-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        <div class="right-sidebar">
            <!-- 标签按钮 -->
            <div class="tabs">
                <button class="tab-button active" data-tab="info">信息面板</button>
                <button class="tab-button" data-tab="poi-list">周边POI</button>
                <button class="tab-button" data-tab="route">路线规划</button>
                <!-- <button class="tab-button" data-tab="favorites">收藏景点</button> -->
            </div>

            <!-- 标签内容 -->
            <div id="info" class="tab-content active">
                <h3>信息面板</h3>
                <p>点击地图上的<span style="color: blue;">蓝色标记</span>（景点）查看周边POI。</p>
                <p>点击地图上的<span style="color: red;">红色标记</span>（POI）可查看详细信息。</p>
                <div id="spot-details">
                    <!-- 景点详情将显示在这里 -->
                </div>
            </div>

            <div id="poi-list" class="tab-content">
                <h3>周边POI列表</h3>
                <p>点击景点后，这里将显示周边的兴趣点。</p>
                <ul id="poi-ul">
                    <!-- POI 列表项将动态添加到这里 -->
                </ul>
            </div>

            <div id="route" class="tab-content">
                <h3>路线规划</h3>
                <p>在这里可以规划您的旅游路线</p>
                <form>
                    <div>
                        <label>起点：</label>
                        <input type="text" placeholder="选择起点">
                    </div>
                    <div style="margin-top: 10px;">
                        <label>终点：</label>
                        <input type="text" placeholder="选择终点">
                    </div>
                    <button type="button" style="margin-top: 10px;" onclick="planRoute()">规划路线</button>
                </form>
                <hr> <!-- Optional separator -->
                <h4>已选地点：</h4>
                <div id="selected-route-points">
                    <p>尚未选择任何地点。请点击地图标记上的“添加到路线”按钮。</p>
                </div>
            </div>

            <!-- <div id="favorites" class="tab-content">
                <h3>美食列表</h3>
                <p>或许你饿了，这里会显示美食列表</p>
                <ul>
                    <li>暂无美食</li>
                </ul>
            </div> -->
        </div>
    </div>
    <div class="bottom-area">
        <h3>详细信息</h3>
        <p id="details-content">点击地图上的标记以查看详细信息。</p>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 定义地图边界（根据需要调整）
        // const southWest = L.latLng(39.89, 116.36);
        // const northEast = L.latLng(39.94, 116.42);
        // const bounds = L.latLngBounds(southWest, northEast);

        // 初始化地图
        const map = L.map('map', {
            // minZoom: 15, // 可以根据需要设置
            zoomControl: true, // 显示缩放控件
            // maxBounds: bounds, // 可选：限制地图边界
            // maxBoundsViscosity: 1.0
        }).setView([{{lat}}, {{lng}}], 13); // 默认视图和缩放级别

        // 添加OSM瓦片图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 用于存放 POI 标记的图层组
        let poiLayer = L.layerGroup().addTo(map);
        // 用于存放景点标记的图层组
        let scenicSpotLayer = L.layerGroup().addTo(map);
        // 存储当前显示的 POI 数据
        let currentPois = [];
        let routePoints = []; // 存储路线规划的点 {name, lat, lng}
        let routeListContainer; // 在 DOMContentLoaded 后获取

        // 地图大小改变时更新地图
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });

        // --- 标签切换功能 ---
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const poiListUl = document.getElementById('poi-ul');
            const detailsContent = document.getElementById('details-content');
            const spotDetailsDiv = document.getElementById('spot-details'); // 获取景点详情区域
            routeListContainer = document.getElementById('selected-route-points'); // 获取路线点列表容器
            updateRouteListDisplay(); // 初始化显示

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // --- 函数：将点添加到路线列表 ---
            function addPointToRoute(point) {
                // 检查是否已存在（基于坐标）
                const exists = routePoints.some(p => p.lat === point.lat && p.lng === point.lng);
                if (!exists) {
                    routePoints.push(point);
                    updateRouteListDisplay();
                    alert(`"${point.name}" 已添加到路线规划列表！`);
                } else {
                    alert(`"${point.name}" 已在列表中。`);
                }
            }

            // --- 函数：从路线列表中移除点 ---
            function removePointFromRoute(index) {
                if (index >= 0 && index < routePoints.length) {
                    const removed = routePoints.splice(index, 1);
                    console.log("Removed point:", removed[0]);
                    updateRouteListDisplay();
                }
            }

            // --- 函数：更新路线规划标签页中的列表显示 ---
            function updateRouteListDisplay() {
                if (!routeListContainer) return; // 确保容器存在

                routeListContainer.innerHTML = ''; // 清空

                if (routePoints.length === 0) {
                    routeListContainer.innerHTML = '<p>尚未选择任何地点。请点击地图标记上的“添加到路线”按钮。</p>';
                    return;
                }

                const ol = document.createElement('ol');
                routePoints.forEach((point, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${point.name}`; // (${point.lat.toFixed(4)}, ${point.lng.toFixed(4)})`; // 可选显示坐标

                    // 添加移除按钮
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '移除';
                    removeBtn.style.marginLeft = '10px';
                    removeBtn.style.cursor = 'pointer';
                    // 使用闭包或 data-* 属性传递索引
                    removeBtn.onclick = function() { removePointFromRoute(index); };

                    li.appendChild(removeBtn);
                    ol.appendChild(li);
                });
                routeListContainer.appendChild(ol);

                // 更新起点/终点输入框（可选）
                updateRouteFormInputs();
            }

            // --- 函数：更新路线规划表单的起点和终点（可选）---
            function updateRouteFormInputs() {
                const startInput = document.querySelector('#route form input[placeholder="选择起点"]');
                const endInput = document.querySelector('#route form input[placeholder="选择终点"]');

                if (startInput) {
                    startInput.value = routePoints.length > 0 ? routePoints[0].name : '';
                }
                if (endInput) {
                    endInput.value = routePoints.length > 1 ? routePoints[routePoints.length - 1].name : '';
                }
            }

            // --- 监听 Popup 打开事件，为内部按钮绑定事件 ---
            map.on('popupopen', function(e) {
                const popupNode = e.popup.getElement();
                const addButton = popupNode.querySelector('.add-to-route-btn');
                if (addButton) {
                    // 确保只绑定一次监听器，或先移除旧的
                    const newButton = addButton.cloneNode(true); // 克隆以移除旧监听器
                    addButton.parentNode.replaceChild(newButton, addButton);

                    newButton.addEventListener('click', () => {
                        const name = newButton.dataset.name;
                        const lat = parseFloat(newButton.dataset.lat);
                        const lng = parseFloat(newButton.dataset.lng);

                        if (name && !isNaN(lat) && !isNaN(lng)) {
                            addPointToRoute({ name, lat, lng });
                            // e.popup._close(); // 可选：添加后关闭弹窗
                        } else {
                            console.error("无法从按钮获取地点数据:", newButton.dataset);
                        }
                    });
                }
            });

            // --- 占位符：实际的路线规划函数 ---
            window.planRoute = function() { // 将函数挂载到 window 使其可在 onclick 中调用
                if (routePoints.length < 2) {
                    alert("请至少选择两个地点（起点和终点）来规划路线。");
                    return;
                }
                // 在这里添加调用路线规划API和在地图上绘制路线的逻辑
                console.log("准备规划路线，选择的点:", routePoints);
                alert("路线规划功能待实现。已选点信息已打印到控制台。");
                // 示例：获取起点和终点坐标
                // const startPoint = routePoints[0];
                // const endPoint = routePoints[routePoints.length - 1];
                // const waypoints = routePoints.slice(1, -1); // 中间点
                // 调用后端API或前端路由库...
            }

            // --- 获取并显示初始景点 ---
            const spotId = {{ spot_id | tojson }}; // 从 Flask 获取 spot_id

            if (spotId) {
                fetch(`/map/${spotId}/api/scenicSpots`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Fetched scenic spots:", data);
                        scenicSpotLayer.clearLayers(); // 清除旧的景点标记

                        if (Array.isArray(data) && data.length > 0) {
                            const bounds = []; // 用于自动缩放地图以包含所有景点
                            data.forEach(spot => {
                                if (spot.location && typeof spot.location.lat === 'number' && typeof spot.location.lng === 'number') {
                                    const lat = spot.location.lat;
                                    const lng = spot.location.lng;
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        const marker = L.marker([lat, lng], {
                                            // 可以为景点设置不同的图标，例如蓝色
                                            icon: L.icon({
                                                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                                                iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
                                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                                iconSize: [25, 41],
                                                iconAnchor: [12, 41],
                                                popupAnchor: [1, -34],
                                                shadowSize: [41, 41],
                                            })
                                        })
                                        .addTo(scenicSpotLayer) // 添加到景点图层

                                        const popupContent = `
                                            <b>${spot.name}</b><br>
                                            ${spot.address || '无地址信息'}<br>
                                            <button class="add-to-route-btn" data-name="${spot.name}" data-lat="${lat}" data-lng="${lng}" style="margin-top: 5px;">添加到路线</button>
                                        `;
                                        marker.bindPopup(popupContent);

                                        // 存储景点信息到标记对象，方便后续使用
                                        marker.spotData = spot;

                                        // --- 添加点击事件监听器 ---
                                        marker.on('click', function() {
                                            const clickedLatLng = this.getLatLng();
                                            const locationString = `${clickedLatLng.lat},${clickedLatLng.lng}`; // 使用 "纬度,经度" 格式
                                            console.log(`Fetching POIs for location: ${locationString}`);

                                            // 更新信息面板显示当前点击的景点
                                            spotDetailsDiv.innerHTML = `
                                                <h4>当前选择: ${this.spotData.name}</h4>
                                                <p>地址: ${this.spotData.address || '无'}</p>
                                                <p>坐标: ${clickedLatLng.lat.toFixed(6)}, ${clickedLatLng.lng.toFixed(6)}</p>
                                            `;
                                            detailsContent.innerHTML = `点击了景点：<b>${this.spotData.name}</b>。正在加载周边POI...`;

                                            // 切换到 POI 列表标签页
                                            document.querySelector('.tab-button[data-tab="poi-list"]').click();
                                            poiListUl.innerHTML = '<li>正在加载...</li>'; // 显示加载提示

                                            fetchPOIs(locationString); // 调用函数获取并显示 POI
                                        });

                                        bounds.push([lat, lng]); // 添加到边界计算数组
                                    } else {
                                        console.warn("Invalid coordinates for spot:", spot.name, spot.location);
                                    }
                                } else {
                                    console.warn("Missing or invalid location data for spot:", spot.name, spot.location);
                                }
                            });
                            // 如果有有效的景点坐标，则自动调整地图视图
                            if (bounds.length > 0) {
                                map.fitBounds(bounds, { padding: [50, 50] }); // 添加一些边距
                            }
                        } else if (data && data.error) {
                             console.error("API Error:", data.error);
                             alert('加载景点信息失败: ' + data.error);
                        }
                         else {
                            console.error("Invalid or empty data format received from API:", data);
                            alert('加载景点信息失败：未找到景点数据或格式不正确。');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching or processing scenic spots:', error);
                        alert('加载景点信息失败: ' + error.message);
                        detailsContent.innerHTML = `加载景点信息失败: ${error.message}`;
                    });
            } else {
                console.error('Spot ID not found in template.');
                alert('无法加载景点信息，缺少景点ID。');
                detailsContent.innerHTML = '无法加载景点信息，缺少景点ID。';
            }

            // --- 函数：获取并显示 POI ---
            function fetchPOIs(locationString) {
                poiLayer.clearLayers(); // 清除旧的 POI 标记
                currentPois = []; // 清空当前 POI 数据
                poiListUl.innerHTML = '<li>正在加载POI...</li>'; // 更新列表状态

                fetch(`/map/api/poi/${locationString}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(pois => {
                        console.log("Fetched POIs:", pois);
                        poiLayer.clearLayers(); // 再次确保清除
                        poiListUl.innerHTML = ''; // 清空列表

                        if (Array.isArray(pois) && pois.length > 0) {
                            currentPois = pois; // 存储 POI 数据
                            pois.forEach((poi, index) => {
                                // 假设 POI 数据结构为 { name: '...', location: { lat: ..., lng: ... }, address: '...', type: '...' }
                                // 后端返回的 location 可能是字符串 "经度,纬度" 或对象 {lat: ..., lng: ...}
                                let lat, lng;
                                if (poi.location && typeof poi.location === 'object' && typeof poi.location.lat === 'number' && typeof poi.location.lng === 'number') {
                                    lat = poi.location.lat;
                                    lng = poi.location.lng;
                                } else if (typeof poi.location === 'string' && poi.location.includes(',')) {
                                    // 尝试解析 "经度,纬度" 或 "纬度,经度" 字符串
                                    const parts = poi.location.split(',');
                                    // 假设高德API返回的是 "经度,纬度"
                                    lng = parseFloat(parts[0]);
                                    lat = parseFloat(parts[1]);
                                    // 如果需要 "纬度,经度"
                                    // lat = parseFloat(parts[0]);
                                    // lng = parseFloat(parts[1]);
                                }

                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const poiMarker = L.marker([lat, lng], {
                                        // 为 POI 设置不同图标，例如红色
                                        icon: L.icon({
                                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                            iconSize: [25, 41],
                                            iconAnchor: [12, 41],
                                            popupAnchor: [1, -34],
                                            shadowSize: [41, 41]
                                        })
                                    })
                                    .addTo(poiLayer) // 添加到 POI 图层

                                    const popupContent = `
                                        <b>${poi.name || '未知名称'}</b><br>
                                        类型: ${poi.type || '未知'}<br>
                                        地址: ${poi.address || '无'}<br>
                                        <button class="add-to-route-btn" data-name="${poi.name || '未知名称'}" data-lat="${lat}" data-lng="${lng}" style="margin-top: 5px;">添加到路线</button>
                                    `;
                                    poiMarker.bindPopup(popupContent);

                                    // 点击 POI 标记时更新底部详细信息
                                    poiMarker.on('click', function() {
                                        detailsContent.innerHTML = `
                                            <h4>POI详情: ${poi.name || '未知名称'}</h4>
                                            <p>类型: ${poi.type || '未知'}</p>
                                            <p>地址: ${poi.address || '无'}</p>
                                            <p>坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                                            ${poi.score ? `<p>距离中心点: ${poi.score} 米</p>` : ''}
                                        `;
                                    });

                                    // --- 在右侧 POI 列表中添加条目 ---
                                    const listItem = document.createElement('li');
                                    listItem.textContent = `${index + 1}. ${poi.name || '未知名称'} (${poi.type || '未知'}) ${poi.score ? poi.score + '米' : ''}`;
                                    listItem.dataset.index = index; // 存储索引以便查找
                                    listItem.addEventListener('click', function() {
                                        const poiIndex = parseInt(this.dataset.index);
                                        const selectedPoi = currentPois[poiIndex];
                                        let poiLat, poiLng;
                                         if (selectedPoi.location && typeof selectedPoi.location === 'object') {
                                            poiLat = selectedPoi.location.lat;
                                            poiLng = selectedPoi.location.lng;
                                        } else if (typeof selectedPoi.location === 'string') {
                                            const parts = selectedPoi.location.split(',');
                                            poiLng = parseFloat(parts[0]); // 经度
                                            poiLat = parseFloat(parts[1]); // 纬度
                                        }

                                        if (!isNaN(poiLat) && !isNaN(poiLng)) {
                                            map.setView([poiLat, poiLng], 17); // 移动地图到 POI 并放大
                                            // 找到对应的 marker 并打开 popup
                                            poiLayer.eachLayer(layer => {
                                                // 简单比较坐标，可能需要更精确的匹配方式
                                                const layerLatLng = layer.getLatLng();
                                                if (Math.abs(layerLatLng.lat - poiLat) < 0.00001 && Math.abs(layerLatLng.lng - poiLng) < 0.00001) {
                                                    layer.openPopup();
                                                }
                                            });
                                             detailsContent.innerHTML = `
                                                <h4>POI详情: ${selectedPoi.name || '未知名称'}</h4>
                                                <p>类型: ${selectedPoi.type || '未知'}</p>
                                                <p>地址: ${selectedPoi.address || '无'}</p>
                                                <p>坐标: ${poiLat.toFixed(6)}, ${poiLng.toFixed(6)}</p>
                                                ${selectedPoi.score ? `<p>距离中心点: ${selectedPoi.score} 米</p>` : ''}
                                            `;
                                        }
                                    });
                                    poiListUl.appendChild(listItem);

                                } else {
                                    console.warn("Invalid coordinates for POI:", poi.name, poi.location);
                                }
                            });
                            detailsContent.innerHTML = `已加载 ${pois.length} 个周边POI。点击标记或右侧列表项查看详情。`;
                        } else {
                            console.log("No POIs found or invalid data format:", pois);
                            poiListUl.innerHTML = '<li>附近未找到相关POI。</li>';
                            detailsContent.innerHTML = '附近未找到相关POI。';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching or processing POIs:', error);
                        alert('加载周边POI失败: ' + error.message);
                        poiListUl.innerHTML = `<li>加载POI失败: ${error.message}</li>`;
                        detailsContent.innerHTML = `加载POI失败: ${error.message}`;
                    });
            }

        }); // End of DOMContentLoaded
    </script>
</body>
</html>