<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™¯åŒºæœç´¢</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 960px; margin: 190px auto 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 25px; }
        .controls { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding: 20px; background-color: #eef; border-radius: 5px; }
        .controls > div { display: flex; flex-direction: column; flex: 1; min-width: 180px; }
        .controls label { margin-bottom: 8px; font-weight: bold; font-size: 0.9em; color: #555; }
        .controls input[type="text"],
        .controls select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .spots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; list-style: none; padding: 0; }
        .spots-grid li { background-color: #fff; border: 1px solid #eee; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: transform 0.2s ease; }
        .spots-grid li:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .spots-grid img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .spot-info { padding: 15px; }
        .spot-info h3 { margin: 0 0 10px 0; font-size: 1.2em; color: #333; }
        .spot-info p { margin: 5px 0; font-size: 0.9em; color: #666; }
        .spot-info .score { font-weight: bold; color: #e67e22; }
        .spot-info .type { background-color: #e7f5ff; color: #228be6; padding: 3px 8px; border-radius: 12px; display: inline-block; font-size: 0.8em; }
        .loading, .no-results { text-align: center; padding: 30px; color: #888; font-size: 1.1em; grid-column: 1 / -1; /* Span across all columns if grid is empty */}
        
        /* ä»index.htmlå¤åˆ¶çš„æ ·å¼ */
        .image-container {
            position: absolute;
            left: 380px;
            top: 29px;
            transform: translateY(-50%);
            width: 280px;
            height: 80px;
            background: url('../static/dogo.png') center center/contain no-repeat;
            z-index: 999;
            cursor: pointer;
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
            position: relative;
            top: 20px;
        }
        .header span {
            font-weight: bold;
            position: absolute;
            right: 32%;
            display: flex;
            align-items: center;
            height: 100%;
            top: 22px;
        }
        .header .search-bar {
            display: flex;
            max-width: 400px;
            height: 48px;
            gap: 0px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 5px;
        }
        .header .search-bar select {
            padding: 12px 16px;
            border: 1px solid #CCCCCC;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            min-width: 100px;
        }
        .header .search-input {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            height: 46px;
            top: 1px;
        }
        .header .search-input svg {
            position: absolute;
            left: 16px;
            pointer-events: none;
        }
        .header .search-input input {
            width: 100%;
            height: 46px;
            padding: 0 16px 0 48px;
            border: 1px solid #CCCCCC;
            border-left: none;
            border-right: none;
            font-size: 14px;
        }
        .header .search-input input::placeholder {
            color: #999999;
        }
        .header .search-button {
            padding: 12px 16px;
            background-color: #FF6600;
            color: #FFFFFF;
            border: none;
            border-radius: 0 4px 4px 0;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header .search-button:hover {
            background-color: #E55C00;
        }
        .header .search-button:active {
            transform: translateY(1px);
        }
        .header .actions {
            display: flex;
            gap: 10px;
            position: absolute;
            right: 29%;
            top: 17px;
        }
        .header button, .header a.button {
            padding: 0;
            cursor: pointer;
            text-decoration: none;
            background-color: transparent;
            border: none;
            color: #333;
        }
        .header a.button:hover {
            color: #0066cc;
        }
        #logout-button {
            font-size: 16px;
            margin-left: 10px;
        }
        #logout-button:hover {
            color: #0066cc;
        }
        
        /* è“è‰²å¯¼èˆªæ æ ·å¼ */
        .blue-container {
            position: absolute;
            top: 125px;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #0052d9;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .nav-item {
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-item:hover {
            background-color: #003bb3;
        }
        
        /* æ·»åŠ æ¨èæ™¯åŒºçš„æ©™è‰²èƒŒæ™¯æ ·å¼ */
        .nav-item.orange {
            background-color: #FF6600;
        }
        
        .nav-item.orange:hover {
            background-color: #E55C00;
        }
        
        @media (max-width: 768px) {
            .header .search-bar { height: 40px; }
            .header .search-button span { display: none; }
            .header .search-button::after { content: "ğŸ”"; }
        }
    </style>
</head>
<body>

<!-- ä»index.htmlå¤åˆ¶çš„å¤´éƒ¨å…ƒç´  -->
<div class="header">
    <a href="/" style="text-decoration: none;">
        <div class="image-container"></div>
    </a>
    <span id="username">è®¿å®¢</span>
    <div class="search-bar">
        <select aria-label="æœç´¢ç±»å‹">
            <option value="spot">æ™¯åŒº</option>
            <option value="diary">æ—¥è®°</option>
        </select>
        <div class="search-input">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="#666666">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" placeholder="è¯·è¾“å…¥å…³é”®è¯" aria-label="æœç´¢å…³é”®è¯">
        </div>
        <button class="search-button">æœç´¢</button>
    </div>
    <div class="actions">
        <button id="logout-button">ç™»å‡º</button>
    </div>
</div>

<!-- ä»index.htmlå¤åˆ¶çš„è“è‰²å¯¼èˆªæ  -->
<div class="blue-container">
    <div class="nav-item orange" onclick="window.location.href='/spots/search'">
        æ¨èæ™¯åŒº
    </div>
    <div class="nav-item" onclick="window.location.href='/spots/spot_info/143'">
        å£ç¢‘æ—¥è®°
    </div>
</div>

<div class="container">
    <h1>æ¢ç´¢æ™¯åŒº</h1>

    <div class="controls">
        <div>
            <label for="search-keyword">å…³é”®è¯æœç´¢:</label>
            <input type="text" id="search-keyword" placeholder="è¾“å…¥æ™¯åŒºåç§°...">
        </div>
        <div>
            <label for="filter-type">æŒ‰ç±»å‹ç­›é€‰:</label>
            <select id="filter-type">
                <option value="">æ‰€æœ‰ç±»å‹</option>
                <!-- ç±»å‹é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
            </select>
        </div>
        <div>
            <label for="sort-by">æ’åºæ–¹å¼:</label>
            <select id="sort-by">
                <option value="default">é»˜è®¤æ’åº</option>
                <option value="popularity_desc">çƒ­åº¦ é«˜ â†’ ä½</option>
            </select>
        </div>
    </div>

    <ul id="spots-list" class="spots-grid">
        <li class="loading">æ­£åœ¨åŠ è½½æ™¯åŒºæ•°æ®...</li>
    </ul>
    <div id="no-results" class="no-results" style="display: none;">æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ™¯åŒºã€‚</div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-keyword');
        const typeFilter = document.getElementById('filter-type');
        const sortBy = document.getElementById('sort-by');
        const spotsList = document.getElementById('spots-list');
        const noResultsDiv = document.getElementById('no-results');
        const usernameSpan = document.getElementById('username');
        const logoutButton = document.getElementById('logout-button');
        const headerSearchBar = document.querySelector('.header .search-bar');
        const headerSearchSelect = headerSearchBar.querySelector('select');
        const headerSearchInput = headerSearchBar.querySelector('input');
        const headerSearchButton = headerSearchBar.querySelector('.search-button');

        const spotTypes = [
            "å†å²å»ºç­‘", "èµèŠ±èƒœåœ°", "èŒèŒåŠ¨ç‰©", "åŸå¸‚æ¼«æ­¥", "å¤œæ¸¸è§‚æ™¯",
            "é›å¨ƒå®è—åœ°", "å±•é¦†å±•è§ˆ", "åœ°æ ‡è§‚æ™¯", "ç™»é«˜çˆ¬å±±", "è¸é’å¿…å»",
            "è‡ªç„¶å±±æ°´", "æ¸¸ä¹åœº", "æ¼”å‡º"
        ];

        // å¡«å……ç±»å‹ç­›é€‰ä¸‹æ‹‰æ¡†
        spotTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeFilter.appendChild(option);
        });
        
        // è§£æURLå‚æ•°ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„ç­›é€‰æ¡ä»¶
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const keywordParam = urlParams.get('keyword');
            const typeParam = urlParams.get('type');
            
            if (keywordParam) {
                searchInput.value = keywordParam;
            }
            
            if (typeParam && spotTypes.includes(typeParam)) {
                typeFilter.value = typeParam;
            }
            
            // åŠ è½½URLå‚æ•°åç«‹å³è·å–æ•°æ®
            fetchAndDisplaySpots();
        }

        // è·å–å¹¶æ˜¾ç¤ºæ™¯ç‚¹æ•°æ® (æ ¹æ®å½“å‰ç­›é€‰å’Œæ’åºæ¡ä»¶)
        function fetchAndDisplaySpots() {
            spotsList.innerHTML = '<li class="loading">æ­£åœ¨åŠ è½½æ™¯åŒºæ•°æ®...</li>'; // æ˜¾ç¤ºåŠ è½½æç¤º
            noResultsDiv.style.display = 'none';

            // 1. è·å–å½“å‰ç­›é€‰å’Œæ’åºå‚æ•°
            const keyword = searchInput.value.trim();
            const selectedType = typeFilter.value;
            const sortValue = sortBy.value;

            // 2. æ„å»º API è¯·æ±‚ URL (å¸¦æŸ¥è¯¢å‚æ•°)
            // *** ç¡®ä¿åç«¯æœ‰ /api/search-spots æ¥å£æ¥å¤„ç†è¿™äº›å‚æ•° ***
            const apiUrl = new URL('/api/search-spots', window.location.origin); // ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ„å»º
            if (keyword) {
                apiUrl.searchParams.append('keyword', keyword);
            }
            if (selectedType) {
                apiUrl.searchParams.append('type', selectedType);
            }
            if (sortValue !== 'default') {
                apiUrl.searchParams.append('sort_by', sortValue);
            }

            // 3. å‘é€è¯·æ±‚
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 4. å¤„ç†å“åº”å¹¶æ˜¾ç¤ºç»“æœ
                    if (data.success && Array.isArray(data.spots)) {
                        displaySpots(data.spots);
                    } else {
                        spotsList.innerHTML = '<li class="loading">åŠ è½½æ™¯ç‚¹æ•°æ®å¤±è´¥æˆ–æ ¼å¼é”™è¯¯ã€‚</li>';
                        console.error('è·å–æ™¯ç‚¹æ•°æ®å¤±è´¥:', data.message || 'æ ¼å¼é”™è¯¯');
                        displaySpots([]); // æ¸…ç©ºåˆ—è¡¨å¹¶å¯èƒ½æ˜¾ç¤ºæ— ç»“æœæç¤º
                    }
                })
                .catch(error => {
                    spotsList.innerHTML = '<li class="loading">åŠ è½½æ™¯ç‚¹æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚</li>';
                    console.error('è·å–æœç´¢ç»“æœæ—¶å‡ºé”™:', error);
                    displaySpots([]); // æ¸…ç©ºåˆ—è¡¨å¹¶å¯èƒ½æ˜¾ç¤ºæ— ç»“æœæç¤º
                });
        }

        // æ˜¾ç¤ºæ™¯ç‚¹åˆ—è¡¨ (æ­¤å‡½æ•°åŸºæœ¬ä¸å˜)
        function displaySpots(spotsToDisplay) {
            spotsList.innerHTML = ''; // æ¸…ç©ºå½“å‰åˆ—è¡¨
            noResultsDiv.style.display = 'none';

            if (!spotsToDisplay || spotsToDisplay.length === 0) {
                noResultsDiv.style.display = 'block';
                spotsList.innerHTML = ''; // Ensure list is empty when showing no results
                return;
            }

            spotsToDisplay.forEach(spot => {
                const li = document.createElement('li');
                const imgHtml = spot.img ? `<img src="${spot.img}" alt="${spot.name || 'æ™¯åŒºå›¾ç‰‡'}">` : '<div style="height: 180px; background: #eee; display: flex; align-items: center; justify-content: center; color: #aaa;">æ— å›¾</div>';
                const name = spot.name || 'æœªçŸ¥æ™¯ç‚¹';
                const score = (spot.score !== undefined && spot.score !== null) ? parseFloat(spot.score).toFixed(1) : 'N/A';
                const type = spot.type || 'æœªçŸ¥ç±»å‹';
                const popularity = (spot.visited_time !== undefined && spot.visited_time !== null) ? parseInt(spot.visited_time) : 'N/A'; // å‡è®¾ visited_time æ˜¯çƒ­åº¦

                li.innerHTML = `
                    ${imgHtml}
                    <div class="spot-info">
                        <h3><a href="/spots/spot_info/${spot.id}">${name}</a></h3> <!-- ä¿®æ”¹è¿™é‡Œï¼Œå°†åå­—å˜ä¸ºé“¾æ¥ -->
                        <p>è¯„åˆ†: <span class="score">${score}</span></p>
                        <p>çƒ­åº¦: ${popularity}</p>
                        <p>ç±»å‹: <span class="type">${type}</span></p>
                    </div>
                `;
                spotsList.appendChild(li);

            });
        }

        // å¤„ç†é¡¶éƒ¨æœç´¢æ 
        function handleHeaderSearch() {
            const keyword = headerSearchInput.value.trim();
            if (!keyword) {
                // ç©ºå…³é”®è¯æç¤º
                headerSearchInput.style.borderColor = 'red';
                headerSearchInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    headerSearchInput.style.borderColor = '#CCCCCC';
                    headerSearchInput.style.animation = '';
                }, 500);
                return;
            }
            
            const searchType = headerSearchSelect.value;
            const apiUrl = new URL('/api/search-spots', window.location.origin);
            apiUrl.searchParams.append('keyword', keyword);
            if (searchType === 'diary') {
                apiUrl.searchParams.append('type', 'diary');
            }
            
            window.location.href = `/spots/search?keyword=${encodeURIComponent(keyword)}`;
        }
        
        // æ·»åŠ é¡¶éƒ¨æœç´¢æ äº‹ä»¶ç›‘å¬
        headerSearchButton.addEventListener('click', handleHeaderSearch);
        headerSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleHeaderSearch();
            }
        });
        
        // å¤„ç†ç™»å‡º
        logoutButton.addEventListener('click', () => {
            fetch('/api/logout', { method: 'POST' })
                .then(response => {
                    window.location.href = '/login';
                })
                .catch(error => {
                    console.error('ç™»å‡ºæ—¶å‡ºé”™:', error);
                    window.location.href = '/login';
                });
        });
        
        // æ£€æŸ¥ä¼šè¯å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
        fetch('/api/check-session')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    usernameSpan.textContent = data.user.username || 'ç”¨æˆ·';
                } else if (data) {
                    console.error('ä¼šè¯æ£€æŸ¥å¤±è´¥:', data.message);
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥ä¼šè¯æ—¶å‡ºé”™:', error);
                usernameSpan.textContent = 'é”™è¯¯';
                window.location.href = '/login';
            });

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ (æ¯æ¬¡æ”¹å˜éƒ½é‡æ–°è·å–æ•°æ®)
        // ä½¿ç”¨ debounce æˆ– throttle ä¼˜åŒ–é¢‘ç¹è§¦å‘çš„ input äº‹ä»¶ (å¯é€‰)
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(fetchAndDisplaySpots, 300); // å»¶è¿Ÿ 300ms è§¦å‘æœç´¢ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        });
        typeFilter.addEventListener('change', fetchAndDisplaySpots);
        sortBy.addEventListener('change', fetchAndDisplaySpots);

        // åˆå§‹åŠ è½½æ•°æ® (è§£æURLå‚æ•°å¹¶åº”ç”¨)
        parseUrlParameters();
    });
</script>

</body>
</html>
