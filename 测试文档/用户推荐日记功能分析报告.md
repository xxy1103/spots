# ç”¨æˆ·æ¨èæ—¥è®°åŠŸèƒ½åˆ†ææŠ¥å‘Š

## æ–¹æ³•æ¦‚è¿°

**getRecommendDiariesTraditional** æ˜¯ä¸ªæ€§åŒ–æ—…æ¸¸ç³»ç»Ÿä¸­çš„æ ¸å¿ƒæ¨èç®—æ³•ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·çš„å…´è¶£åå¥½ä¸ºå…¶æ¨èç›¸å…³çš„æ—…è¡Œæ—¥è®°ã€‚è¯¥æ–¹æ³•é‡‡ç”¨ä¼ ç»Ÿçš„å¤šè·¯å½’å¹¶æ’åºç­–ç•¥ï¼Œé€šè¿‡åˆ†æç”¨æˆ·å–œå¥½çš„æ™¯ç‚¹ç±»å‹ï¼Œæ”¶é›†ç›¸å…³æ—¥è®°å¹¶æŒ‰è¯„åˆ†è¿›è¡Œæ’åºæ¨èã€‚

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡
- **æ—¶é—´å¤æ‚åº¦**: O(N log N) 
- **ç©ºé—´å¤æ‚åº¦**: O(N)
- **å½’å¹¶ç­–ç•¥**: K-way merge

## ç®—æ³•æµç¨‹å›¾

```mermaid
flowchart TD
    A[ğŸ” è·å–ç”¨æˆ·ä¿¡æ¯] --> B{ç”¨æˆ·æ˜¯å¦å­˜åœ¨?}
    B -->|å¦| C[âŒ è¿”å› None]
    B -->|æ˜¯| D[ğŸ“‹ è·å–ç”¨æˆ·å…´è¶£æ ‡ç­¾]
    D --> E[ğŸ”„ éå†å…´è¶£ç±»å‹]
    E --> F[ğŸï¸ è·å–è¯¥ç±»å‹æ‰€æœ‰æ™¯ç‚¹]
    F --> G[ğŸ“– æå–æ¯ä¸ªæ™¯ç‚¹çš„Topæ—¥è®°]
    G --> H[ğŸ“š æ”¶é›†æ‰€æœ‰æ—¥è®°åˆ—è¡¨]
    H --> I[ğŸ”€ K-wayå½’å¹¶æ’åº]
    I --> J[ğŸ¯ è¿”å›TopKæ¨èç»“æœ]
```

## æ•°æ®ç»“æ„åˆ†æ

### 1. Userå¯¹è±¡
- **ç”¨é€”**: å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œå…´è¶£åå¥½
- **å…³é”®å±æ€§**: likes_type (å…´è¶£æ ‡ç­¾åˆ—è¡¨)
- **æ—¶é—´å¤æ‚åº¦**: O(1) è®¿é—®ç”¨æˆ·ä¿¡æ¯

### 2. SpotManager
- **ç”¨é€”**: ç®¡ç†æ™¯ç‚¹æ•°æ®å’Œåˆ†ç±»ç´¢å¼•
- **å…³é”®æ–¹æ³•**: getTopKByType() è·å–åˆ†ç±»æ™¯ç‚¹
- **æ—¶é—´å¤æ‚åº¦**: O(k) è·å–kä¸ªæ™¯ç‚¹

### 3. TopKHeapæ•°ç»„
- **ç”¨é€”**: ä¸ºæ¯ä¸ªæ™¯ç‚¹ç»´æŠ¤å…¶æ—¥è®°çš„æœ€å¤§å †
- **å…³é”®æ“ä½œ**: getTopK() è·å–å‰kä¸ªæ—¥è®°
- **æ—¶é—´å¤æ‚åº¦**: O(k log n) å †æ“ä½œ

### 4. K-wayå½’å¹¶
- **ç”¨é€”**: åˆå¹¶å¤šä¸ªå·²æ’åºçš„æ—¥è®°åˆ—è¡¨
- **æ•°æ®ç»“æ„**: MinHeap + å¤šè·¯æŒ‡é’ˆ
- **æ—¶é—´å¤æ‚åº¦**: O(N log k) å½’å¹¶kä¸ªåˆ—è¡¨

### 5. Diaryå¯¹è±¡
- **ç”¨é€”**: å­˜å‚¨æ—¥è®°çš„è¯¦ç»†ä¿¡æ¯
- **æ’åºé”®**: score(è¯„åˆ†), visited_time(è®¿é—®é‡)
- **æ—¶é—´å¤æ‚åº¦**: O(1) å±æ€§è®¿é—®

### 6. æ¨èåˆ—è¡¨
- **ç”¨é€”**: å­˜å‚¨æœ€ç»ˆçš„æ¨èç»“æœ
- **ç»“æ„**: List[Diary] æœ‰åºåˆ—è¡¨
- **æ—¶é—´å¤æ‚åº¦**: O(k) æ„å»ºç»“æœåˆ—è¡¨

## ç®—æ³•æ­¥éª¤è¯¦è§£

### æ­¥éª¤1: ç”¨æˆ·éªŒè¯ä¸æ•°æ®è·å–
é€šè¿‡ userId è·å–ç”¨æˆ·å¯¹è±¡ï¼ŒéªŒè¯ç”¨æˆ·å­˜åœ¨æ€§ï¼Œæå–ç”¨æˆ·çš„å…´è¶£æ ‡ç­¾åˆ—è¡¨ likes_type

```python
user = self.getUser(userId)
user_likes = user.likes_type
```

### æ­¥éª¤2: å…´è¶£ç±»å‹éå†
éå†ç”¨æˆ·çš„æ¯ä¸ªå…´è¶£ç±»å‹ï¼Œä¸ºæ¯ç§ç±»å‹æ”¶é›†ç›¸å…³çš„æ™¯ç‚¹å’Œæ—¥è®°æ•°æ®

```python
for spot_type in user_likes:
    spots_of_type = spotManager.getTopKByType(spot_type, k=-1)
```

### æ­¥éª¤3: æ™¯ç‚¹æ—¥è®°æå–
å¯¹äºæ¯ä¸ªæ™¯ç‚¹ï¼Œä»å…¶ä¸“å±çš„TopKHeapä¸­æå–å‰topKä¸ªé«˜è¯„åˆ†æ—¥è®°

```python
for spot in spots_of_type:
    spot_id = spot["id"]
    diarys = spotManager.spotDiaryHeapArray[spot_id-1].getTopK(topK)
```

### æ­¥éª¤4: æ—¥è®°åˆ—è¡¨æ”¶é›†
å°†æ‰€æœ‰è·å–åˆ°çš„æ—¥è®°åˆ—è¡¨æ·»åŠ åˆ°æ¨èåˆ—è¡¨é›†åˆä¸­ï¼Œå½¢æˆå¤šä¸ªå·²æ’åºçš„å­åˆ—è¡¨

```python
if diarys:
    recommended_diaries.append(diarys)
```

### æ­¥éª¤5: K-wayå½’å¹¶æ’åº
ä½¿ç”¨kè·¯å½’å¹¶ç®—æ³•å°†å¤šä¸ªå·²æ’åºçš„æ—¥è®°åˆ—è¡¨åˆå¹¶ä¸ºä¸€ä¸ªå…¨å±€æœ‰åºçš„æ¨èåˆ—è¡¨

```python
recommended_diaries = kwaymerge.k_way_merge_descending(recommended_diaries)
```

### æ­¥éª¤6: ç»“æœæ„å»ºä¸è¿”å›
ä»å½’å¹¶ç»“æœä¸­é€‰å–å‰topKä¸ªæ—¥è®°IDï¼Œè·å–å®Œæ•´çš„æ—¥è®°å¯¹è±¡å¹¶è¿”å›

```python
diarys = []
for i in range(topK):
    diarys.append(diaryManager.getDiary(recommended_diaries[i]["id"]))
```

## æ—¶é—´å¤æ‚åº¦åˆ†æ

| æ“ä½œæ­¥éª¤ | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜ |
|---------|-----------|------|
| ç”¨æˆ·éªŒè¯ | O(1) | å“ˆå¸Œè¡¨æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ |
| è·å–å…´è¶£ç±»å‹æ™¯ç‚¹ | O(S) | Sä¸ºè¯¥ç±»å‹æ™¯ç‚¹æ€»æ•° |
| æ™¯ç‚¹æ—¥è®°æå– | O(k log n) | ä»å †ä¸­è·å–å‰kä¸ªå…ƒç´  |
| K-wayå½’å¹¶æ’åº | O(N log L) | Nä¸ºæ€»æ—¥è®°æ•°ï¼ŒLä¸ºåˆ—è¡¨æ•°é‡ |
| ç»“æœå¯¹è±¡æ„å»º | O(k) | æ„å»ºkä¸ªæ—¥è®°å¯¹è±¡ |
| **æ€»ä½“å¤æ‚åº¦** | **O(N log N)** | dominated by å½’å¹¶æ’åº |

### å¤æ‚åº¦å˜é‡è¯´æ˜

| å˜é‡ | å«ä¹‰ | å…¸å‹èŒƒå›´ |
|-----|------|---------|
| N | æ‰€æœ‰ç›¸å…³æ—¥è®°çš„æ€»æ•°é‡ | 100 ~ 10,000 |
| k | ç”¨æˆ·è¯·æ±‚çš„æ¨èæ—¥è®°æ•°é‡(topK) | 5 ~ 50 |
| L | éœ€è¦å½’å¹¶çš„æ—¥è®°åˆ—è¡¨æ•°é‡ | 10 ~ 100 |
| S | å•ä¸ªå…´è¶£ç±»å‹çš„æ™¯ç‚¹æ•°é‡ | 20 ~ 200 |
| T | ç”¨æˆ·å…´è¶£ç±»å‹çš„æ•°é‡ | 1 ~ 10 |

## K-wayå½’å¹¶ç®—æ³•ç»†èŠ‚

K-wayå½’å¹¶æ’åºæ˜¯è¯¥æ¨èç®—æ³•çš„æ ¸å¿ƒç»„ä»¶ï¼Œä½¿ç”¨æœ€å°å †æ¥é«˜æ•ˆåˆå¹¶å¤šä¸ªå·²æ’åºçš„æ—¥è®°åˆ—è¡¨ã€‚

### ç®—æ³•åŸç†

1. **åˆå§‹åŒ–æœ€å°å †**: åˆ›å»ºMinHeapï¼Œå°†æ¯ä¸ªåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŠ å…¥å †ä¸­ï¼Œå †å…ƒç´ æ ¼å¼ä¸ºï¼š(-value1, -value2, list_index, item_index, item_dict)

2. **å½’å¹¶è¿‡ç¨‹**: é‡å¤æ‰§è¡Œï¼šä»å †é¡¶å¼¹å‡ºæœ€å¤§å…ƒç´ ï¼ŒåŠ å…¥ç»“æœåˆ—è¡¨ï¼Œå¦‚æœè¯¥å…ƒç´ æ‰€åœ¨åˆ—è¡¨è¿˜æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™å°†ä¸‹ä¸€ä¸ªå…ƒç´ åŠ å…¥å †

3. **æ’åºç­–ç•¥**: ä½¿ç”¨è´Ÿå€¼æŠ€å·§ï¼š-value1ä½œä¸ºä¸»æ’åºé”®ï¼Œ-value2ä½œä¸ºæ¬¡æ’åºé”®ï¼Œå®ç°é™åºæ’åˆ—

```python
def k_way_merge_descending(list_of_lists):
    min_heap = MinHeap()
    result = []
    
    # åˆå§‹åŒ–å †
    for i, sub_list in enumerate(list_of_lists):
        if sub_list:
            item = sub_list[0]
            heap_item = (-item['value1'], -item['value2'], i, 0, item)
            min_heap.push(heap_item)
    
    # å½’å¹¶è¿‡ç¨‹
    while not min_heap.is_empty():
        neg_v1, neg_v2, list_idx, item_idx, current_item = min_heap.pop()
        result.append(current_item)
        
        # æ·»åŠ ä¸‹ä¸€ä¸ªå…ƒç´ 
        next_item_idx = item_idx + 1
        if next_item_idx < len(list_of_lists[list_idx]):
            next_item = list_of_lists[list_idx][next_item_idx]
            new_heap_item = (-next_item['value1'], -next_item['value2'], 
                           list_idx, next_item_idx, next_item)
            min_heap.push(new_heap_item)
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ—©æœŸè¿‡æ»¤ä¼˜åŒ–
åœ¨æ™¯ç‚¹çº§åˆ«å°±é™åˆ¶æå–çš„æ—¥è®°æ•°é‡ï¼Œé¿å…è¿‡å¤šæ— æ•ˆæ•°æ®å‚ä¸å½’å¹¶æ’åºï¼Œå‡å°‘æ•´ä½“è®¡ç®—é‡ã€‚

### 2. åˆ†é¡µæ¨è
å®ç°åˆ†é¡µæ¨èæœºåˆ¶ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ¨èç»“æœï¼Œæé«˜å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒã€‚

### 3. ç¼“å­˜ç­–ç•¥
å¯¹ç”¨æˆ·æ¨èç»“æœè¿›è¡Œç¼“å­˜ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œå‡å°‘é‡å¤è®¡ç®—å¼€é”€ã€‚

### 4. å¹¶è¡Œå¤„ç†
å¯¹ä¸åŒå…´è¶£ç±»å‹çš„æ•°æ®æ”¶é›†è¿‡ç¨‹è¿›è¡Œå¹¶è¡ŒåŒ–å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUèµ„æºã€‚

## ç®—æ³•ä¼˜ç¼ºç‚¹åˆ†æ

### ä¼˜ç‚¹
- âœ… ç»“æœå‡†ç¡®æ€§é«˜ï¼Œå……åˆ†è€ƒè™‘ç”¨æˆ·å…´è¶£
- âœ… æ’åºç¨³å®šï¼Œä¿è¯æ¨èè´¨é‡ä¸€è‡´æ€§
- âœ… ç®—æ³•é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… æ”¯æŒå¤šç»´åº¦æ’åºï¼ˆè¯„åˆ†+è®¿é—®é‡ï¼‰

### ç¼ºç‚¹
- âŒ æ—¶é—´å¤æ‚åº¦è¾ƒé«˜ï¼Œå¤§æ•°æ®é‡æ—¶æ€§èƒ½å—é™
- âŒ å†…å­˜å ç”¨è¾ƒå¤§ï¼Œéœ€å­˜å‚¨æ‰€æœ‰å€™é€‰æ—¥è®°
- âŒ å®æ—¶æ€§ä¸è¶³ï¼Œæ— æ³•å¿«é€Ÿå“åº”æ•°æ®å˜åŒ–
- âŒ ç¼ºä¹ä¸ªæ€§åŒ–æƒé‡è°ƒæ•´æœºåˆ¶

## æ€»ç»“

**getRecommendDiariesTraditional** æ–¹æ³•å®ç°äº†ä¸€ä¸ªåŸºäºç”¨æˆ·å…´è¶£çš„ä¼ ç»Ÿæ¨èç®—æ³•ï¼Œé€šè¿‡å¤šè·¯å½’å¹¶æ’åºç¡®ä¿äº†æ¨èç»“æœçš„å‡†ç¡®æ€§å’Œæœ‰åºæ€§ã€‚è¯¥ç®—æ³•åœ¨ä¸­å°è§„æ¨¡æ•°æ®é›†ä¸Šè¡¨ç°è‰¯å¥½ï¼Œä¸ºç”¨æˆ·æä¾›äº†é«˜è´¨é‡çš„ä¸ªæ€§åŒ–æ¨èæœåŠ¡ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- **ç¨³å®š**çš„æ’åºç®—æ³•
- **å¤šç»´**çš„æ’åºæ ‡å‡†  
- **ä¸ªæ€§åŒ–**çš„æ¨èç­–ç•¥

æœªæ¥å¯ä»¥è€ƒè™‘å¼•å…¥æœºå™¨å­¦ä¹ ç®—æ³•ã€å®æ—¶è®¡ç®—æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†æŠ€æœ¯ï¼Œè¿›ä¸€æ­¥æå‡æ¨èç³»ç»Ÿçš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚
